<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Kas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100">

  <nav class="bg-blue-700 text-white p-4 flex justify-between">
    <h1 class="font-bold text-xl">Dashboard Uang Kas</h1>
    <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded">Logout</button>
  </nav>

  <div class="p-5">

    <p id="role" class="mb-4 text-gray-700"></p>

    <!-- FORM ADMIN -->
    <div id="adminForm" class="mb-6 hidden">
      <h2 class="font-semibold text-lg mb-2">Tambah Transaksi</h2>

      <div class="grid grid-cols-2 gap-3">
        <input id="tanggal" type="date" class="border p-2 rounded" />
        <input id="ket" placeholder="Keterangan" class="border p-2 rounded" />
        <input id="masuk" type="number" placeholder="Masuk" class="border p-2 rounded" />
        <input id="keluar" type="number" placeholder="Keluar" class="border p-2 rounded" />
      </div>

      <button onclick="tambah()"
              class="mt-3 bg-green-600 text-white px-4 py-2 rounded">
        Tambah
      </button>
    </div>

    <!-- TABLE -->
    <table class="w-full bg-white shadow rounded overflow-hidden">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2">Tanggal</th>
          <th class="p-2">Keterangan</th>
          <th class="p-2">Masuk</th>
          <th class="p-2">Keluar</th>
          <th class="p-2">Saldo</th>
          <th class="p-2">Aksi</th>
        </tr>
      </thead>

      <tbody id="tbody"></tbody>
    </table>

  </div>

<script>
  const supabase = supabase.createClient("YOUR_URL", "YOUR_ANON_KEY");
  let userRole = "user";

  // cek session login
  supabase.auth.getSession().then(async ({ data: { session } }) => {
    if (!session) window.location = "index.html";

    userRole = session.user.user_metadata.role;
    document.getElementById("role").innerText = "Role: " + userRole;

    if (userRole === "admin") {
      adminForm.classList.remove("hidden");
    }

    loadData();
  });

  async function loadData() {
    const { data } = await supabase.from("uangkas").select("*").order("id");
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    data.forEach(row => {
      tbody.innerHTML += `
        <tr class="border-b">
          <td class="p-2">${row.tanggal}</td>
          <td class="p-2">${row.keterangan}</td>
          <td class="p-2">${row.masuk}</td>
          <td class="p-2">${row.keluar}</td>
          <td class="p-2">${row.saldo}</td>
          <td class="p-2">
            ${userRole === "admin" ?
              `<button onclick="hapus(${row.id})"
                       class='bg-red-600 text-white px-2 py-1 rounded'>
                Hapus
              </button>` : `-`
            }
          </td>
        </tr>
      `;
    });
  }

  async function tambah() {
    const tanggal = tanggal.value;
    const ket = ket.value;
    const masukVal = Number(masuk.value);
    const keluarVal = Number(keluar.value);
    const saldo = masukVal - keluarVal;

    await supabase.from("uangkas").insert({
      tanggal, keterangan: ket, masuk: masukVal, keluar: keluarVal, saldo
    });

    loadData();
  }

  async function hapus(id) {
    await supabase.from("uangkas").delete().eq("id", id);
    loadData();
  }

  async function logout() {
    await supabase.auth.signOut();
    window.location = "index.html";
  }
</script>

</body>
</html>
